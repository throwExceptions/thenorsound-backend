# ğŸ¯ ThenorSound Microservices - Architecture Diagrams & Flow Charts

**Datum:** 2026-02-09  
**Version:** 1.0  
**Syfte:** Visual representation av arkitektur, dataflÃ¶den och kommunikationsmÃ¶nster

---

## 1. System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Frontend (React/JavaScript)                        â”‚
â”‚                          soundflow/                                     â”‚
â”‚                                                                         â”‚
â”‚  â”œâ”€ User Authentication UI                                             â”‚
â”‚  â”œâ”€ Customer Management                                                â”‚
â”‚  â”œâ”€ Event Scheduling                                                   â”‚
â”‚  â”œâ”€ Crew Booking (calling User Service for crew members)              â”‚
â”‚  â””â”€ Invoice Management                                                 â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”‚ HTTP/REST (JSON)
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API Gateway (Port 5000)                          â”‚
â”‚                                                                         â”‚
â”‚  â”œâ”€ Request Routing (YARP)                                             â”‚
â”‚  â”œâ”€ JWT Token Validation                                               â”‚
â”‚  â”œâ”€ Rate Limiting                                                      â”‚
â”‚  â”œâ”€ CORS Handling                                                      â”‚
â”‚  â””â”€ Request/Response Logging                                           â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚              â”‚             â”‚              â”‚            â”‚              â”‚
  â–¼              â–¼             â–¼              â–¼            â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Auth   â”‚  â”‚ User   â”‚  â”‚  Customer   â”‚ â”‚ Event  â”‚ â”‚  Booking    â”‚
â”‚Service  â”‚  â”‚Service â”‚  â”‚   Service   â”‚ â”‚Service â”‚  â”‚  Service    â”‚
â”‚         â”‚  â”‚        â”‚  â”‚             â”‚ â”‚        â”‚  â”‚             â”‚
â”‚Port5001 â”‚  â”‚Port5002â”‚  â”‚  Port 5003  â”‚ â”‚Port5004â”‚  â”‚  Port 5005  â”‚
â”‚(Auth)   â”‚  â”‚(Users+ â”‚  â”‚(Organizers+ â”‚ â”‚(Events)â”‚  â”‚ (Bookings + â”‚
â”‚         â”‚  â”‚ Crew)  â”‚  â”‚ Tariffs)    â”‚ â”‚        â”‚  â”‚  Invoices)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚           â”‚               â”‚            â”‚            â”‚
     â”‚ MongoDB   â”‚ MongoDB       â”‚ MongoDB    â”‚ MongoDB    â”‚ MongoDB
     â”‚ (1 DB: thenorsound - all services share same database & collections)
     â–¼           â–¼               â–¼            â–¼            â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  MongoDB Collections (Single DB: thenorsound)         â”‚
  â”‚  â”œâ”€ auth_refreshTokens                               â”‚
  â”‚  â”œâ”€ users (userType: 1,2,3 incl. crew)              â”‚
  â”‚  â”œâ”€ customers (customerType: 1,2 incl. crew co's)   â”‚
  â”‚  â”œâ”€ events                                            â”‚
  â”‚  â””â”€ bookings                                          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**KEY CHANGE:** No separate Crew Service! Crew members are Users (userType: 3) in User Service.

---

## 2. Request Flow - User Login

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  FRONTEND (soundflow)                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  User enters email & password                                         â”‚
â”‚  onClick: loginUser(email, password)                                  â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ POST /api/auth/login
                 â”‚ { email, password }
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  API GATEWAY (Port 5000)                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚  1. Receive request                                                   â”‚
â”‚  2. Route to: /api/auth/* â†’ http://localhost:5001                    â”‚
â”‚  3. Forward to Auth Service                                          â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Forward POST /api/auth/login
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  AUTH SERVICE (Port 5001)                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  LoginCommandHandler:                                                 â”‚
â”‚  1. Receive { email, password }                                       â”‚
â”‚  2. Hash password with bcrypt                                         â”‚
â”‚  3. Query User DB â†’ find user by email                               â”‚
â”‚  4. Compare password hashes                                           â”‚
â”‚  5. If match:                                                         â”‚
â”‚     â”œâ”€ Generate AccessToken (15 min expiry)                          â”‚
â”‚     â”œâ”€ Generate RefreshToken (7 days expiry)                         â”‚
â”‚     â”œâ”€ Store RefreshToken in DB with TTL                           â”‚
â”‚     â””â”€ Return { accessToken, refreshToken, expiresIn }               â”‚
â”‚  6. If no match: Return 401 Unauthorized                              â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Response: 200 OK
                 â”‚ { accessToken, refreshToken, expiresIn }
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  API GATEWAY (Port 5000)                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚  1. Receive response from Auth Service                               â”‚
â”‚  2. Return to Frontend                                                â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Response: 200 OK
                 â”‚ { accessToken, refreshToken, expiresIn }
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  FRONTEND (soundflow)                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  1. Receive token response                                            â”‚
â”‚  2. Store accessToken in memory/localStorage                          â”‚
â”‚  3. Store refreshToken in secure HTTP-only cookie (server-set)       â”‚
â”‚  4. Update UserContext with authenticated state                       â”‚
â”‚  5. Redirect to dashboard                                             â”‚
â”‚  6. Set Authorization header for future requests:                     â”‚
â”‚     Authorization: Bearer {accessToken}                               â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Booking Creation Flow (Complex Cross-Service)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  FRONTEND (soundflow)                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚  User selects: Crew + Event + Date/Time                                 â”‚
â”‚  Submit booking request                                                 â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ POST /api/bookings
                       â”‚ {
                       â”‚   eventId: "evt-123",
                       â”‚   crewId: "crew-456",
                       â”‚   startTime: "2026-03-01T18:00:00Z",
                       â”‚   endTime: "2026-03-01T22:00:00Z"
                       â”‚ }
                       â”‚
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  API GATEWAY (5000)  â”‚
            â”‚  - Route to Booking  â”‚
            â”‚  - Forward request   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  BOOKING SERVICE (Port 5006) â”‚
        â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚  CreateBookingCommandHandler â”‚
        â”‚                              â”‚
        â”‚  Step 1: Get Event Details   â”‚
        â”‚  (Synchronous call)          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ GET /api/events/evt-123
                     â”‚ Authorization: Bearer {token}
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ EVENT SERVICE (Port 5004)  â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚ GetEventQueryHandler       â”‚
        â”‚                            â”‚
        â”‚ Response:                  â”‚
        â”‚ {                          â”‚
        â”‚   id: "evt-123",          â”‚
        â”‚   customerId: "cust-789", â”‚
        â”‚   name: "Summer Concert"  â”‚
        â”‚ }                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  BOOKING SERVICE (Port 5005) â”‚  NOTE: Changed from 5006 to 5005
        â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚  Step 2: Check Crew Avail.  â”‚
        â”‚  (Synchronous call)         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ GET /api/users/crew-456/availability?date=2026-03-01
                     â”‚ (Crew member is User with userType: 3)
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  USER SERVICE (Port 5002)  â”‚ â† CHANGED: User Service, not Crew
        â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
        â”‚  GetCrewAvailabilityQuery  â”‚
        â”‚                            â”‚
        â”‚  âœ“ Crew member IS availableâ”‚
        â”‚                            â”‚
        â”‚  Response: { isAvailable: true }
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  BOOKING SERVICE (Port 5005) â”‚
        â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚  Step 3: Get Tariffs        â”‚
        â”‚  (Synchronous call)         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ GET /api/customers/cust-789/tariffs
                     â”‚ (CustomerType: 1 = EventOrganizer)
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ CUSTOMER SERVICE (Port 5003)   â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚ GetTariffsByCustomerQuery      â”‚
        â”‚                                â”‚
        â”‚ Response:                      â”‚
        â”‚ [                              â”‚
        â”‚   {                            â”‚
        â”‚     id: "tar-001",            â”‚
        â”‚     category: "Musician",     â”‚
        â”‚     skill: "Guitar",          â”‚
        â”‚     timeType: "Hour",         â”‚
        â”‚     amount: 500 SEK           â”‚
        â”‚   }                            â”‚
        â”‚ ]                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  BOOKING SERVICE (Port 5005) â”‚
        â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚  Step 4: Match Crew Skills   â”‚
        â”‚  to Tariffs                  â”‚
        â”‚                              â”‚
        â”‚  Crew skills: [Guitar]       â”‚
        â”‚  Matching tariff: 500 SEK/hr â”‚
        â”‚                              â”‚
        â”‚  Duration: 4 hours           â”‚
        â”‚  TotalAmount: 2000 SEK       â”‚
        â”‚                              â”‚
        â”‚  Step 5: Create Booking      â”‚
        â”‚  - Save to MongoDB           â”‚
        â”‚  - Status: REQUESTED         â”‚
        â”‚                              â”‚
        â”‚  Step 6: Publish Event       â”‚
        â”‚  (Asynchronous to RabbitMQ) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ PUBLISH to RabbitMQ
                     â”‚ Topic: "booking.created"
                     â”‚ Message: BookingCreatedEvent
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â”‚
         â–¼                        â–¼
   [CONSUMED BY]            [STORED IN DB]
   Notification Service      Booking MongoDB
   Analytics Service         
   
   Notifications sent:
   - Email to customer
   - Email to crew member
   - SMS notification
   
         â”‚                        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  BOOKING SERVICE (Port 5005) â”‚
        â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚  Return Response:            â”‚
        â”‚  {                           â”‚
        â”‚    id: "book-001",          â”‚
        â”‚    eventId: "evt-123",      â”‚
        â”‚    crewId: "crew-456",      â”‚
        â”‚    startTime: "...",        â”‚
        â”‚    endTime: "...",          â”‚
        â”‚    rate: 500,               â”‚
        â”‚    totalAmount: 2000,       â”‚
        â”‚    status: "REQUESTED"      â”‚
        â”‚  }                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  API GATEWAY (5000)  â”‚
            â”‚  - Return response   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  FRONTEND (soundflow)                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚  Success! Booking created                                               â”‚
â”‚  - Show confirmation message                                            â”‚
â”‚  - Display booking details                                              â”‚
â”‚  - Redirect to bookings page                                            â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Authentication & Authorization Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚  REQUEST WITH TOKEN                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚                                                                     â”‚
â”‚  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...  â”‚
â”‚                                                                     â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚  API GATEWAY (Port 5000)                                           â”‚
â”‚  Auth Middleware:                                                  â”‚
â”‚                                                                     â”‚
â”‚  1. Extract token from Authorization header                        â”‚
â”‚  2. If no token â†’ Return 401 Unauthorized                         â”‚
â”‚  3. If token exists â†’ Validate with Auth Service                  â”‚
â”‚                                                                     â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”‚ POST /api/auth/validate
  â”‚ Header: Authorization: Bearer {token}
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚  AUTH SERVICE (Port 5001)                                          â”‚
â”‚  Validate Token:                                                   â”‚
â”‚                                                                     â”‚
â”‚  âœ“ Valid token & not expired                                       â”‚
â”‚    â””â”€ Extract claims: { userId, email, roles }                   â”‚
â”‚    â””â”€ Return: { isValid: true, userId, roles }                   â”‚
â”‚                                                                     â”‚
â”‚  âœ— Expired token                                                   â”‚
â”‚    â””â”€ Return: { isValid: false, reason: "EXPIRED" }              â”‚
â”‚                                                                     â”‚
â”‚  âœ— Invalid/tampered token                                         â”‚
â”‚    â””â”€ Return: { isValid: false, reason: "INVALID" }              â”‚
â”‚                                                                     â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚  API GATEWAY (Port 5000)                                           â”‚
â”‚                                                                     â”‚
â”‚  IF VALID:                                                         â”‚
â”‚  â”œâ”€ Add X-User-Id header: {userId}                                â”‚
â”‚  â”œâ”€ Add X-User-Roles header: {roles}                              â”‚
â”‚  â”œâ”€ Route request to target service                               â”‚
â”‚                                                                     â”‚
â”‚  IF EXPIRED:                                                       â”‚
â”‚  â”œâ”€ Check if refresh token exists (in HTTP-only cookie)          â”‚
â”‚  â”œâ”€ If exists, Call Auth Service: POST /api/auth/refresh         â”‚
â”‚  â”œâ”€ If refresh successful:                                        â”‚
â”‚  â”‚  â”œâ”€ Set new tokens in response                                â”‚
â”‚  â”‚  â”œâ”€ Retry original request with new token                     â”‚
â”‚  â”‚  â””â”€ Return combined response                                   â”‚
â”‚  â”œâ”€ If refresh fails:                                             â”‚
â”‚  â”‚  â””â”€ Return 401 Unauthorized â†’ Frontend logs out               â”‚
â”‚                                                                     â”‚
â”‚  IF INVALID:                                                       â”‚
â”‚  â””â”€ Return 401 Unauthorized                                       â”‚
â”‚                                                                     â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚  TARGET SERVICE (e.g., User Service)                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  Receives request with:                                            â”‚
â”‚  - X-User-Id: "user-123"                                           â”‚
â”‚  - X-User-Roles: "CustomerAdmin"                                   â”‚
â”‚                                                                     â”‚
â”‚  Authorization logic:                                              â”‚
â”‚  â”œâ”€ Check if user has required role                               â”‚
â”‚  â”œâ”€ Check resource-level permissions                              â”‚
â”‚  â”œâ”€ If authorized: Process request                                â”‚
â”‚  â”œâ”€ If unauthorized: Return 403 Forbidden                         â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Data Consistency - Booking Creation Saga

```
USER INITIATES BOOKING
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         â”‚ CreateBookingCommand
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ BOOKING SERVICE                     â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚ 1. Create tentative booking         â”‚
    â”‚    Status: PENDING                  â”‚
    â”‚    Save to DB                       â”‚
    â”‚    bookingId = "book-001"           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         SAGA INITIATED        â”‚
              â”œâ”€ On Success â†’ Continue
              â”œâ”€ On Failure â†’ Compensate
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ STEP 1: RESERVE EVENT SLOT          â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
    â”‚ EVENT SERVICE                       â”‚
    â”‚                                     â”‚
    â”‚ Call: ReserveEventSlot(             â”‚
    â”‚   eventId="evt-123",        â”‚
    â”‚   startTime, endTime        â”‚
    â”‚ )                                   â”‚
    â”‚                                     â”‚
    â”‚ âœ“ Success: Slot reserved            â”‚
    â”‚ âœ— Failure: Slot already taken      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                â–¼
    SUCCESS         FAILURE
        â”‚             â”‚
        â”‚             â–¼
        â”‚      COMPENSATE:
        â”‚      Booking Service
        â”‚      UpdateStatus(book-001, CANCELLED)
        â”‚      Return error to API Gateway
        â”‚             â”‚
        â”‚             â””â”€â†’ API Gateway (Port 5000)
        â”‚                  â”‚
        â”‚                  â””â”€â†’ FRONTEND
        â”‚                     Error: "Event slot unavailable"
        â”‚
        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ STEP 2: RESERVE CREW SLOT            â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚ CREW SERVICE                        â”‚
    â”‚                                     â”‚
    â”‚ Call: ReserveCrewSlot(              â”‚
    â”‚   crewId="crew-456",               â”‚
    â”‚   startTime, endTime               â”‚
    â”‚ )                                   â”‚
    â”‚                                     â”‚
    â”‚ âœ“ Success: Crew reserved            â”‚
    â”‚ âœ— Failure: Crew unavailable        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                 â–¼
    SUCCESS          FAILURE
        â”‚              â”‚
        â”‚              â–¼
        â”‚        COMPENSATE:
        â”‚        1. Event Service
        â”‚           ReleaseEventSlot(evt-123, ...)
        â”‚        2. Booking Service
        â”‚           UpdateStatus(book-001, CANCELLED)
        â”‚        Return error
        â”‚
        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ STEP 3: CALCULATE PRICE              â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚ CUSTOMER SERVICE                    â”‚
    â”‚                                     â”‚
    â”‚ Call: GetTariffs(customerId)       â”‚
    â”‚ Calculate: rate * duration         â”‚
    â”‚                                     â”‚
    â”‚ âœ“ Success: Price calculated         â”‚
    â”‚ âœ— Failure: No tariffs found        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                 â–¼
    SUCCESS          FAILURE
        â”‚              â”‚
        â”‚              â–¼
        â”‚        COMPENSATE:
        â”‚        1. Event Service: ReleaseEventSlot
        â”‚        2. Crew Service: ReleaseCrewSlot
        â”‚        3. Booking Service: UpdateStatus(CANCELLED)
        â”‚        Return error
        â”‚
        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ STEP 4: COMMIT BOOKING               â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚ BOOKING SERVICE                     â”‚
    â”‚                                     â”‚
    â”‚ 1. Update booking status: CONFIRMEDâ”‚
    â”‚ 2. Save totalAmount                â”‚
    â”‚ 3. Publish BookingConfirmed event  â”‚
    â”‚    to message broker (RabbitMQ)    â”‚
    â”‚                                     â”‚
    â”‚ âœ“ Success: Booking confirmed        â”‚
    â”‚ âœ— Failure: DB error (rare)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                 â–¼
    SUCCESS          FAILURE
        â”‚              â”‚
        â”‚              â–¼
        â”‚        COMPENSATE:
        â”‚        1. Release all reservations
        â”‚        2. Publish BookingFailed event
        â”‚        3. Alert via logs
        â”‚
        â–¼
    BookingConfirmedEvent published
    â”œâ”€ Notification Service listens
    â”‚  â”œâ”€ Send email to customer
    â”‚  â”œâ”€ Send email to crew
    â”‚  â””â”€ Send SMS notification
    â”‚
    â”œâ”€ Analytics Service listens
    â”‚  â””â”€ Track booking metrics
    â”‚
    â””â”€ Invoice Service listens
       â”œâ”€ Create invoice
       â””â”€ Set due date
```

---

## 6. Message Flow - Event Bus (RabbitMQ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                    â”‚
â”‚  PUBLISHER SERVICES                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                    â”‚
â”‚  User Service              Event Service                          â”‚
â”‚  â”œâ”€ UserCreated    Xâ”€â”€â”    â”œâ”€ EventCreated                      â”‚
â”‚  â””â”€ UserDeleted       â”‚    â”œâ”€ EventUpdated                      â”‚
â”‚                       â”‚    â””â”€ EventDeleted                      â”‚
â”‚  Crew Service         â”‚             â”‚                            â”‚
â”‚  â”œâ”€ CrewCreated       â”‚             â”‚                            â”‚
â”‚  â””â”€ CrewUpdated       â”‚             â”‚                            â”‚
â”‚                       â”‚             â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  Booking Service      â”‚             â”‚              â”‚ RabbitMQ â”‚  â”‚
â”‚  â”œâ”€ BookingCreated    â”‚             â”‚              â”‚          â”‚  â”‚
â”‚  â”œâ”€ BookingConfirmed  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¤ Exchanges:â”‚  â”‚
â”‚  â””â”€ BookingCancelled        â”‚              â”‚       â”‚          â”‚  â”‚
â”‚                             â”‚              â”‚       â”œâ”€user.*   â”‚  â”‚
â”‚                             â”‚              â”‚       â”œâ”€event.*  â”‚  â”‚
â”‚  Invoice Service            â”‚              â”‚       â”œâ”€booking.*â”‚  â”‚
â”‚  â””â”€ InvoiceGenerated â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚       â”‚          â”‚  â”‚
â”‚                             â”‚              â”‚       â”‚ Dead Letterâ”‚ â”‚
â”‚                             â”‚              â”‚       â”‚ Queue    â”‚  â”‚
â”‚                             â”‚              â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                             â”‚              â”‚              â”‚       â”‚
â”‚                             â–¼              â–¼              â–¼       â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                   â”‚ Topic Exchange: thenorsound.events             â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                    â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                â”‚                â”‚
                    â–¼                â–¼                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Notification Svc â”‚  â”‚Analytics Svc â”‚ â”‚ Invoice Service  â”‚
         â”‚ Queue            â”‚  â”‚ Queue        â”‚ â”‚ Queue            â”‚
         â”‚                  â”‚  â”‚              â”‚ â”‚                  â”‚
         â”‚ Subscribes:      â”‚  â”‚Subscribes:   â”‚ â”‚ Subscribes:      â”‚
         â”‚ - user.*         â”‚  â”‚ - *.{created â”‚ â”‚ - booking.*      â”‚
         â”‚ - event.*        â”‚  â”‚   ,updated}  â”‚ â”‚ - invoice.*      â”‚
         â”‚ - booking.*      â”‚  â”‚              â”‚ â”‚                  â”‚
         â”‚ - invoice.*      â”‚  â”‚ Collects:    â”‚ â”‚ Actions:         â”‚
         â”‚                  â”‚  â”‚ - Metrics    â”‚ â”‚ - Create invoice â”‚
         â”‚ Actions:         â”‚  â”‚ - Trends     â”‚ â”‚ - Send to A/P    â”‚
         â”‚ - Send email     â”‚  â”‚ - Reports    â”‚ â”‚ - Track payments â”‚
         â”‚ - Send SMS       â”‚  â”‚              â”‚ â”‚                  â”‚
         â”‚ - Push notif     â”‚  â”‚              â”‚ â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Routing Keys (Topic Patterns):**
```
user.created           â†’ Notification, Analytics
user.deleted           â†’ Notification, Analytics
event.created          â†’ Notification, Analytics
event.updated          â†’ Analytics
event.deleted          â†’ Notification, Analytics
booking.created        â†’ Notification, Analytics, Invoice Service
booking.confirmed      â†’ Notification, Invoice Service
booking.cancelled      â†’ Notification, Analytics
invoice.generated      â†’ Notification
invoice.paid           â†’ Analytics, Accounting Service (future)
```

---

## 7. Database Topology & Relationships

```
MICROSERVICES ARCHITECTURE - DATABASE ISOLATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Azure Cosmos DB (MongoDB API)
â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  thenorsound-auth                   â”‚
â”‚  Collections:                       â”‚
â”‚  â””â”€ refreshTokens                   â”‚
â”‚     - UserId: string (indexed)      â”‚
â”‚     - Token: string                 â”‚
â”‚     - ExpiresAt: DateTime (TTL)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  thenorsound-users                  â”‚
â”‚  Collections:                       â”‚
â”‚  â””â”€ users                           â”‚
â”‚     - Id: string (PK)               â”‚
â”‚     - Email: string (UNIQUE)        â”‚
â”‚     - FirstName: string             â”‚
â”‚     - LastName: string              â”‚
â”‚     - Role: enum                    â”‚
â”‚     - CustomerId: string            â”‚â—„â”€â”€â”€â”€â”€â”
â”‚     - CreatedAt: DateTime           â”‚      â”‚
â”‚     - UpdatedAt: DateTime           â”‚      â”‚ Foreign Key
â”‚                                     â”‚      â”‚ (Reference only)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  thenorsound-customers              â”‚      â”‚
â”‚  Collections:                       â”‚      â”‚
â”‚  â””â”€ customers                       â”‚      â”‚
â”‚     - Id: string (PK)       â—„â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
â”‚     - Name: string                  â”‚
â”‚     - OrgNumber: string (UNIQUE)   â”‚
â”‚     - Address: string               â”‚
â”‚     - Email: string                 â”‚
â”‚     - Phone: string                 â”‚
â”‚     - CustomerType: enum            â”‚
â”‚     - IsActive: bool                â”‚
â”‚     - CreatedAt: DateTime           â”‚
â”‚     - UpdatedAt: DateTime           â”‚
â”‚                                     â”‚
â”‚  â””â”€ tariffs                         â”‚
â”‚     - Id: string (PK)               â”‚
â”‚     - CustomerId: string (FK)       â”‚
â”‚     - Category: enum                â”‚
â”‚     - Skill: enum                   â”‚
â”‚     - TimeType: enum                â”‚
â”‚     - Amount: decimal               â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  thenorsound-events                 â”‚
â”‚  Collections:                       â”‚
â”‚  â””â”€ events                          â”‚
â”‚     - Id: string (PK)               â”‚
â”‚     - CustomerId: string (REF)â—„â”€â”€â”€â”€â”€â”¼â”€ Can query/audit
â”‚     - Name: string                  â”‚
â”‚     - Description: string           â”‚
â”‚     - StartDate: DateTime           â”‚
â”‚     - EndDate: DateTime             â”‚
â”‚     - Location: string              â”‚
â”‚     - EventType: enum               â”‚
â”‚     - Status: enum                  â”‚
â”‚     - Details: object               â”‚
â”‚     - CreatedAt: DateTime           â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  thenorsound-crew                   â”‚
â”‚  Collections:                       â”‚
â”‚  â””â”€ crew                            â”‚
â”‚     - Id: string (PK)               â”‚
â”‚     - CustomerId: string (REF)â—„â”€â”€â”€â”€â”€â”¼â”€ Can query/audit
â”‚     - FirstName: string             â”‚
â”‚     - LastName: string              â”‚
â”‚     - Category: enum                â”‚
â”‚     - Skills: array                 â”‚
â”‚     - Email: string                 â”‚
â”‚     - Phone: string                 â”‚
â”‚     - IsActive: bool                â”‚
â”‚     - CreatedAt: DateTime           â”‚
â”‚                                     â”‚
â”‚  â””â”€ availability                    â”‚
â”‚     - CrewId: string (FK)           â”‚
â”‚     - StartDate: DateTime           â”‚
â”‚     - EndDate: DateTime             â”‚
â”‚     - IsAvailable: bool             â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  thenorsound-bookings               â”‚
â”‚  Collections:                       â”‚
â”‚  â””â”€ bookings                        â”‚
â”‚     - Id: string (PK)               â”‚
â”‚     - EventId: string (REF)â—„â”€â”€â”€â”€â”   â”‚
â”‚     - CrewId: string (REF)â—„â”€â”€â”  â”‚   â”‚
â”‚     - CustomerId: string (REF)â”œâ”€â”€â”¼â”€â”€â”€â”¼â”€ All relationships
â”‚     - BookingDate: DateTime    â”‚  â”‚   â”‚  are references
â”‚     - Status: enum             â”‚  â”‚   â”‚  (denormalized)
â”‚     - TotalAmount: decimal     â”‚  â”‚   â”‚
â”‚     - CreatedAt: DateTime      â”‚  â”‚   â”‚
â”‚                                â”‚  â”‚   â”‚
â”‚  â””â”€ invoices                   â”‚  â”‚   â”‚
â”‚     - Id: string (PK)          â”‚  â”‚   â”‚
â”‚     - BookingId: string (FK)â—„â”€â”€â”˜  â”‚   â”‚
â”‚     - CustomerId: string (REF)â”€â”€â”€â”€â”´â”€â”€â”€â”¼
â”‚     - InvoiceNumber: string (UNIQUE) â”‚
â”‚     - Amount: decimal               â”‚
â”‚     - Status: enum                  â”‚
â”‚     - CreatedAt: DateTime           â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KEY PRINCIPLES:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ“ Each service has OWN database
âœ“ No cross-database queries
âœ“ Foreign keys are stored as strings (references only)
âœ“ For related data â†’ use HTTP API calls (sync) or events (async)
âœ“ Denormalization is OK (eventual consistency)
âœ“ TTL indexes used for auto-cleanup (auth tokens)
```

---

## 8. Deployment Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DEVELOPER                                      â”‚
â”‚                   Push to Git (main)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ GitHub Actions (CI/CD)     â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚                            â”‚
        â”‚ 1. Checkout code           â”‚
        â”‚ 2. Run tests               â”‚
        â”‚ 3. Build Docker image      â”‚
        â”‚ 4. Push to ACR             â”‚
        â”‚ 5. Deploy to staging       â”‚
        â”‚ 6. Run E2E tests           â”‚
        â”‚                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚STAGING ENV  â”‚   â”‚   DEV ENV   â”‚
         â”‚             â”‚   â”‚             â”‚
         â”‚Status: Pass â”‚   â”‚Status: Pass â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚                 â”‚
                â”‚                 â”‚ (All tests pass)
                â”‚                 â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Manual Approval Required   â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚ DevOps Engineer reviews    â”‚
        â”‚ Approve deployment to Prod â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Deploy to PRODUCTION     â”‚
        â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
        â”‚   1. Pull image from ACR   â”‚
        â”‚   2. Using Helm charts     â”‚
        â”‚   3. Rolling deployment    â”‚
        â”‚   4. Health checks         â”‚
        â”‚   5. Smoke tests           â”‚
        â”‚                            â”‚
        â”‚   Result: All services up  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MONITORING & ALERTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”œâ”€ Application Insights (Azure)
â”‚  â”œâ”€ Request times
â”‚  â”œâ”€ Error rates
â”‚  â”œâ”€ Database performance
â”‚  â””â”€ Dependency tracking
â”‚
â”œâ”€ Log Analytics (Azure)
â”‚  â”œâ”€ Centralized logs
â”‚  â”œâ”€ Log queries
â”‚  â””â”€ Alerts on patterns
â”‚
â””â”€ Alerts (PagerDuty/Teams)
   â”œâ”€ Error rate > 5%
   â”œâ”€ Response time > 2s
   â”œâ”€ Service unavailable
   â””â”€ Database connection issues
```

---

## 9. Error Handling & Retry Strategy

```
REQUEST FLOW WITH ERROR HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend sends request             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ API Gateway            â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
        â”‚ 1st attempt            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚          â”‚          â”‚
     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”
     â”‚Successâ”‚  â”‚Timeoutâ”‚  â”‚Error  â”‚
     â”‚2xx    â”‚  â”‚       â”‚  â”‚5xx    â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”˜
          â”‚         â”‚          â”‚
          â”‚         â–¼          â–¼
          â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    â”‚ Retry with Logic    â”‚
          â”‚    â”‚ (Exponential Backoff)
          â”‚    â”‚                     â”‚
          â”‚    â”‚ Retry 1: Wait 100ms â”‚
          â”‚    â”‚ Retry 2: Wait 200ms â”‚
          â”‚    â”‚ Retry 3: Wait 400ms â”‚
          â”‚    â”‚                     â”‚
          â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚             â”‚
          â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    â”‚                 â”‚
          â”‚    â–¼                 â–¼
          â”‚  Success         Max Retries
          â”‚                  Exceeded
          â”‚                    â”‚
          â”‚                    â–¼
          â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚       â”‚ Circuit Breaker     â”‚
          â”‚       â”‚ OPEN: Stop requests â”‚
          â”‚       â”‚ HALF-OPEN: Try again
          â”‚       â”‚ CLOSED: Normal      â”‚
          â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚
          â”‚                â–¼
          â”‚       Return error to
          â”‚       Frontend with
          â”‚       appropriate message
          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚            â”‚
                   â–¼            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Return 200 OK  â”‚  â”‚Return error  â”‚
        â”‚ with data      â”‚  â”‚(4xx or 5xx)  â”‚
        â”‚                â”‚  â”‚              â”‚
        â”‚ Frontend shows â”‚  â”‚ Frontend     â”‚
        â”‚ success        â”‚  â”‚ shows error  â”‚
        â”‚                â”‚  â”‚ "Try again"  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Retry Configuration:**
```
HttpClient retry policy:
â”œâ”€ Max retries: 3
â”œâ”€ Delay strategy: Exponential backoff
â”‚  â”œâ”€ Base: 100ms
â”‚  â”œâ”€ Multiplier: 2
â”‚  â””â”€ Max: 1000ms
â”‚
â”œâ”€ Retry on:
â”‚  â”œâ”€ HTTP 408 (Request Timeout)
â”‚  â”œâ”€ HTTP 429 (Too Many Requests)
â”‚  â”œâ”€ HTTP 5xx (Server Error)
â”‚  â””â”€ TimeoutException
â”‚
â””â”€ Don't retry on:
   â”œâ”€ HTTP 400 (Bad Request)
   â”œâ”€ HTTP 401 (Unauthorized)
   â”œâ”€ HTTP 403 (Forbidden)
   â””â”€ HTTP 404 (Not Found)
```

---

## 10. User Role & Permission Matrix

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     ROLE PERMISSION MATRIX                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘      Role           â•‘         Permissions                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Admin (1)           â•‘ âœ“ View all users/customers/events            â•‘
â•‘                     â•‘ âœ“ Create/edit/delete users                   â•‘
â•‘                     â•‘ âœ“ Create/edit/delete customers               â•‘
â•‘                     â•‘ âœ“ Manage system settings                      â•‘
â•‘                     â•‘ âœ“ View invoices                               â•‘
â•‘                     â•‘ âœ— Not used in initial app                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Customer Admin (2)  â•‘ âœ“ View own customer data                      â•‘
â•‘                     â•‘ âœ“ Create/edit users IN own customer          â•‘
â•‘                     â•‘ âœ“ Create/edit/delete events (own customer)   â•‘
â•‘                     â•‘ âœ“ View bookings & invoices (own customer)     â•‘
â•‘                     â•‘ âœ“ Manage crew members                         â•‘
â•‘                     â•‘ âœ— Cannot see other customers' data            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Customer User (3)   â•‘ âœ“ View own customer data (read-only)         â•‘
â•‘                     â•‘ âœ“ View events (own customer)                 â•‘
â•‘                     â•‘ âœ“ View bookings (own customer, read-only)    â•‘
â•‘                     â•‘ âœ“ View own profile                            â•‘
â•‘                     â•‘ âœ— Cannot create/edit/delete                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Crew Admin (4)      â•‘ âœ“ View own crew members                       â•‘
â•‘                     â•‘ âœ“ Manage crew availability                    â•‘
â•‘                     â•‘ âœ“ View own bookings                           â•‘
â•‘                     â•‘ âœ“ View invoices (own crew)                    â•‘
â•‘                     â•‘ âœ— Cannot see customer data                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Crew User (5)       â•‘ âœ“ View own profile                            â•‘
â•‘                     â•‘ âœ“ View own availability                       â•‘
â•‘                     â•‘ âœ“ View own bookings (read-only)              â•‘
â•‘                     â•‘ âœ“ Update own availability status              â•‘
â•‘                     â•‘ âœ— Cannot view other crew or customers        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

RESOURCE-LEVEL ACCESS CONTROL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User {
  id: "user-123"
  customerId: "cust-789"
  role: CustomerAdmin
}

Accessing Events for Customer "cust-999":
  AuthService:
    â”œâ”€ Validate token: OK
    â”œâ”€ Extract userId, customerId from token
    â””â”€ Pass to Event Service via X-User-CustomerId header

  EventService:
    â”œâ”€ Load event from "cust-999"
    â”œâ”€ Check if user.customerId == event.customerId
    â”œâ”€ If yes: Return event
    â””â”€ If no: Return 403 Forbidden (user owns different customer)
```

---

## Conclusion

Dessa diagram visualiserar:

âœ… **System Architecture** - Hur services Ã¤r organiserade  
âœ… **Request Flows** - FrÃ¥n frontend till backend  
âœ… **Data Flow** - Synkron och asynkron kommunikation  
âœ… **Error Handling** - Retry logic & circuit breaker  
âœ… **Database Topology** - Separation per service   
âœ… **Security** - Auth & authorization  
âœ… **Deployment** - CI/CD pipeline  

**FÃ¶r mer information se:** MICROSERVICES_ARCHITECTURE_SPEC.md

---

**Genererad:** 2026-02-09  
**Version:** 1.0  
**Format:** ASCII Diagrams + Markdown
